<!DOCTYPE html>
<html>
<head>
    <title>Landing Page</title>
    <style>
        table {
            border-collapse: collapse;
            margin-top: 20px;
            width: 100%;
        }

        th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        #jsonOutput {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<h1>Welcome to TimeAndAttendance!</h1>

<h2>Upload Excel File</h2>
<input type="file" id="excelFile" accept=".xlsx,.xls">
<button onclick="convertExcel()">Compute Weekly Hours</button>

<div id="jsonOutput"></div>

<!-- Include SheetJS library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
function convertExcel() {
    const fileInput = document.getElementById('excelFile');
    const outputDiv = document.getElementById('jsonOutput');

    if (!fileInput.files.length) {
        alert('Please select an Excel file first!');
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "", raw: false });

        if (jsonData.length === 0) {
            outputDiv.innerHTML = "<p>No data found in the Excel file.</p>";
            return;
        }

        // --- Display original Excel table ---
        const headers = Object.keys(jsonData[0]);
        let table = "<table><thead><tr>";
        headers.forEach(header => table += `<th>${header}</th>`);
        table += "</tr></thead><tbody>";
        jsonData.forEach(row => {
            table += "<tr>";
            headers.forEach(header => table += `<td>${row[header]}</td>`);
            table += "</tr>";
        });
        table += "</tbody></table>";

        // --- Compute per-day and weekly totals ---
        const WORKDAY_HOURS = 8;

        function hhmmToDecimal(hhmm) {
            const [h, m] = hhmm.split(':').map(Number);
            return h + m / 60;
        }

        function decimalToHHMM(decimalHours) {
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours - hours) * 60);
            return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
        }

        // Group logs by employee + date
        const workLogs = {};
        jsonData.forEach(row => {
            const emp = row['empnum'];
            const name = row['name'];
            const date = row['date'];
            const logtype = row['logtype'].toUpperCase();
            const time = row['time'];

            if (!emp || !date || !time || !logtype) return;

            const key = emp + '|' + date;
            if (!workLogs[key]) workLogs[key] = { empnum: emp, name: name };
            workLogs[key][logtype] = time;
        });

        // Per-employee summary
        const weeklyData = {};

        let perDayTable = "<h3>Per-Day Summary</h3><table><thead><tr><th>Employee</th><th>Date</th><th>Regular Hours</th><th>Overtime</th><th>Undertime</th></tr></thead><tbody>";

        for (const key in workLogs) {
            const log = workLogs[key];
            if (!log['IN'] || !log['OUT']) continue;

            const empKey = log.empnum + ' - ' + log.name;
            if (!weeklyData[empKey]) weeklyData[empKey] = { regular: 0, ot: 0, undertime: 0 };

            const inTime = hhmmToDecimal(log['IN']);
            const outTime = hhmmToDecimal(log['OUT']);
            const hoursWorked = outTime - inTime;

            const regularHours = Math.min(hoursWorked, WORKDAY_HOURS);
            const otHours = Math.max(hoursWorked - WORKDAY_HOURS, 0);
            const undertimeHours = hoursWorked < WORKDAY_HOURS ? WORKDAY_HOURS - hoursWorked : 0;

            // Add to weekly totals
            weeklyData[empKey].regular += regularHours;
            weeklyData[empKey].ot += otHours;
            weeklyData[empKey].undertime += undertimeHours;

            // Add per-day row
            const dateStr = key.split('|')[1];
            perDayTable += `<tr>
                <td>${empKey}</td>
                <td>${dateStr}</td>
                <td>${decimalToHHMM(regularHours)}</td>
                <td>${decimalToHHMM(otHours)}</td>
                <td>${decimalToHHMM(undertimeHours)}</td>
            </tr>`;
        }

        perDayTable += "</tbody></table>";

        // Weekly summary table
        let weeklyTable = "<h3>Weekly Summary</h3><table><thead><tr><th>Employee</th><th>Regular Hours</th><th>Overtime</th><th>Undertime</th></tr></thead><tbody>";
        for (const emp in weeklyData) {
            const data = weeklyData[emp];
            weeklyTable += `<tr>
                <td>${emp}</td>
                <td>${decimalToHHMM(data.regular)}</td>
                <td>${decimalToHHMM(data.ot)}</td>
                <td>${decimalToHHMM(data.undertime)}</td>
            </tr>`;
        }
        weeklyTable += "</tbody></table>";

        outputDiv.innerHTML = table + perDayTable + weeklyTable;
    };

    reader.readAsArrayBuffer(file);
}
</script>


</body>
</html>
